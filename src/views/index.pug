doctype html
html(lang="pt-br")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Heranças do Sul
    link(rel="stylesheet", href="/css/style.css")

  body
    header
      .header-content
        img(src="/img/logo.png", alt="Logo Heranças do Sul", class="logo-header")
        .search-bar
          input#searchInput(type="text", placeholder="Pesquisar produtos...")
        nav.header-nav
          a(href="/carrinho")
            button Carrinho

          if !usuario || !usuario.usuarioId || !usuario.tipo
            a(href="/login")
              button Entrar
            a(href="/usuarios/novo")
              button Cadastrar-se
          else
            if usuario.tipo === 'admin'
              a(href="/categorias/nova")
                button Cadastrar Categoria
              a(href="/produtos/novo")
                button Cadastrar Produto
              a(href="/perfil-admin")
                button.perfil-btn
                  if usuario.fotoPerfil
                    img(src=usuario.fotoPerfil, alt="Perfil", class="perfil-icon")
                  else
                    img(src="/img/user.png", alt="Perfil", class="perfil-icon")
            else
              a(href="/perfil")
                button.perfil-btn
                  if usuario.fotoPerfil
                    img(src=usuario.fotoPerfil, alt="Perfil", class="perfil-icon")
                  else
                    img(src="/img/user.png", alt="Perfil", class="perfil-icon")

    nav.main-nav
      .dropdown
        button.dropbtn Categorias
        .dropdown-content
          each cat in categorias
            a(href="#")= cat.nome

      a(href="#")
        button Novidades
      a(href="#")
        button Descontos
      a(href="#")
        button Populares

    main
      if mensagemSucesso
        .alert-success= mensagemSucesso

      .produtos-grid#produtosGrid
        each produto in produtos
          a.produto-card(
            href="/produtos/" + produto.id, 
            data-nome=produto.nome.toLowerCase(), 
            data-categoria=produto.Categoria ? produto.Categoria.nome : "",
            data-desconto=produto.desconto,
            data-criado=produto.criadoEm ? produto.criadoEm.toISOString() : "",
            data-vendidas=produto.quantidadeVendida || 0
          )
            - let imagemSrc = '/img/placeholder.png'
            - if (produto.imagens)
            -   let imgs = Array.isArray(produto.imagens) ? produto.imagens : []
            -   if (!Array.isArray(produto.imagens) && typeof produto.imagens === 'string') 
            -     try { imgs = JSON.parse(produto.imagens) } catch(e) { imgs = [] }
            -   if (imgs.length > 0) imagemSrc = imgs[0]
            img(src=imagemSrc, alt=produto.nome)
            h3= produto.nome
            p.preco R$ #{produto.preco.toFixed(2)}
            if produto.desconto > 0
              p.desconto Desconto: #{produto.desconto} %

      p#noResults(style="display:none; text-align:center; margin-top:20px; font-size:1.2rem; color:#b7410e;")
        | Nenhum Produto Encontrado

    .footer-bar
      | © 2025 Heranças do Sul - 48 98868-6376

    script.
      const searchInput = document.getElementById("searchInput");
      const produtosGrid = document.getElementById("produtosGrid");
      const noResults = document.getElementById("noResults");
      const produtos = produtosGrid ? produtosGrid.getElementsByClassName("produto-card") : [];

      let filtroAtivo = { tipo: null, valor: null };

      function normalizeString(str) {
        return str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
      }

      function filtrarProdutos(filtroTipo, filtroValor) {
        // Toggle: se clicar no mesmo filtro, remove
        if (filtroAtivo.tipo === filtroTipo && normalizeString(filtroAtivo.valor) === normalizeString(filtroValor || "")) {
          filtroAtivo = { tipo: null, valor: null };
        } else {
          filtroAtivo = { tipo: filtroTipo, valor: filtroValor };
        }

        let found = false;
        Array.from(produtos).forEach(produto => {
          const nome = produto.getAttribute("data-nome");
          const categoria = produto.getAttribute("data-categoria") || "";
          const desconto = parseFloat(produto.getAttribute("data-desconto")) || 0;
          const criadoEm = produto.getAttribute("data-criado") ? new Date(produto.getAttribute("data-criado")) : null;
          const quantidadeVendida = parseInt(produto.getAttribute("data-vendidas")) || 0;

          let mostrar = true;

          if (filtroAtivo.tipo === "nome") {
            mostrar = nome.includes(filtroAtivo.valor);
          } else if (filtroAtivo.tipo === "categoria") {
            mostrar = normalizeString(categoria) === normalizeString(filtroAtivo.valor);
          } else if (filtroAtivo.tipo === "novidades") {
            mostrar = criadoEm ? (new Date() - criadoEm) < (24*60*60*1000) : false;
          } else if (filtroAtivo.tipo === "descontos") {
            mostrar = desconto > 0;
          } else if (filtroAtivo.tipo === "populares") {
            mostrar = quantidadeVendida > 0;
          }

          produto.style.display = mostrar ? "block" : "none";
          if (mostrar) found = true;
        });

        noResults.style.display = found ? "none" : "block";
      }

      // Busca por nome
      if (searchInput) {
        searchInput.addEventListener("input", function() {
          filtrarProdutos("nome", this.value.toLowerCase().trim());
        });
      }

      // Filtro de categorias
      document.querySelectorAll('.dropdown-content a').forEach(link => {
        link.addEventListener("click", function(e) {
          e.preventDefault();
          const categoriaNome = this.textContent.trim();
          if (!categoriaNome) return;
          filtrarProdutos("categoria", categoriaNome);
        });
      });

      // Filtros Novidades, Descontos, Populares
      document.querySelectorAll('.main-nav a').forEach(btn => {
        const btnText = btn.textContent.trim().toLowerCase();
        if (["novidades","descontos","populares"].includes(btnText)) {
          btn.addEventListener("click", function(e){
            e.preventDefault();
            filtrarProdutos(btnText, null);
          });
        }
      });
