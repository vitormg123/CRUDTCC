doctype html
html(lang="pt-br")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Heranças do Sul
    link(rel="stylesheet", href="/css/style.css")

  body
    header
      .header-content
        img(src="/img/logo.png", alt="Logo Heranças do Sul", class="logo-header")
        .search-bar
          input#searchInput(type="text", placeholder="Pesquisar produtos...")
        nav.header-nav
          a(href="/carrinho")
            button Carrinho

          if !usuario || !usuario.usuarioId || !usuario.tipo
            a(href="/login")
              button Entrar
            a(href="/usuarios/novo")
              button Cadastrar-se
          else
            if usuario.tipo === 'admin'
              a(href="/categorias/nova")
                button Cadastrar Categoria
              a(href="/produtos/novo")
                button Cadastrar Produto
              a(href="/perfil-admin")
                button.perfil-btn
                  if usuario.fotoPerfil
                    img(src=usuario.fotoPerfil, alt="Perfil", class="perfil-icon")
                  else
                    img(src="/img/user.png", alt="Perfil", class="perfil-icon")
            else
              a(href="/perfil")
                button.perfil-btn
                  if usuario.fotoPerfil
                    img(src=usuario.fotoPerfil, alt="Perfil", class="perfil-icon")
                  else
                    img(src="/img/user.png", alt="Perfil", class="perfil-icon")

    nav.main-nav
      .dropdown
        button.dropbtn Categorias
        .dropdown-content
          each cat in categorias
            a(href="#")= cat.nome

      a(href="#")
        button Novidades
      a(href="#")
        button Descontos
      a(href="#")
        button Populares

    main
      if mensagemSucesso
        .alert-success= mensagemSucesso

      //- Grid de produtos
      .produtos-grid#produtosGrid
        each produto in produtos
          a.produto-card(
            href="/produtos/" + produto.id, 
            data-nome=produto.nome.toLowerCase(), 
            data-categoria=produto.Categoria ? produto.Categoria.nome.toLowerCase() : "",
            data-desconto=produto.desconto,
            data-criado=produto.criadoEm ? produto.criadoEm.toISOString() : "",
            data-vendidas=produto.quantidadeVendida || 0
          )
            img(src=produto.imagens && JSON.parse(produto.imagens)[0] || '/img/placeholder.png', alt=produto.nome)
            h3= produto.nome
            p.preco R$ #{produto.preco.toFixed(2)}
            if produto.desconto > 0
              p.desconto Desconto: #{produto.desconto} %

      // Mensagem caso não encontre produtos
      p#noResults(style="display:none; text-align:center; margin-top:20px; font-size:1.2rem; color:#b7410e;")
        | Nenhum Produto Encontrado

    .footer-bar
      | © 2025 Heranças do Sul - 48 98868-6376

    script.
      const searchInput = document.getElementById("searchInput");
      const produtosGrid = document.getElementById("produtosGrid");
      const noResults = document.getElementById("noResults");
      const produtos = produtosGrid ? produtosGrid.getElementsByClassName("produto-card") : [];

      function filtrarProdutos(filtroTipo, filtroValor) {
        let found = false;
        Array.from(produtos).forEach(produto => {
          const nome = produto.getAttribute("data-nome");
          const categoria = produto.getAttribute("data-categoria");
          const desconto = parseFloat(produto.getAttribute("data-desconto")) || 0;
          const criadoEm = produto.getAttribute("data-criado") ? new Date(produto.getAttribute("data-criado")) : null;
          const quantidadeVendida = parseInt(produto.getAttribute("data-vendidas")) || 0;

          let mostrar = true;

          if (filtroTipo === "nome") {
            mostrar = nome.includes(filtroValor);
          } else if (filtroTipo === "categoria") {
            mostrar = categoria === filtroValor;
          } else if (filtroTipo === "novidades") {
            if (!criadoEm) mostrar = false;
            else mostrar = (new Date() - criadoEm) < (24 * 60 * 60 * 1000);
          } else if (filtroTipo === "descontos") {
            mostrar = desconto > 0;
          } else if (filtroTipo === "populares") {
            mostrar = quantidadeVendida > 0;
          }

          produto.style.display = mostrar ? "block" : "none";
          if (mostrar) found = true;
        });

        noResults.style.display = found ? "none" : "block";
      }

      if (searchInput) {
        searchInput.addEventListener("input", function() {
          filtrarProdutos("nome", this.value.toLowerCase().trim());
        });
      }

      // Filtro por categorias (dropdown)
      document.querySelectorAll('.dropdown-content a').forEach(link => {
        link.addEventListener("click", function(e) {
          e.preventDefault();
          filtrarProdutos("categoria", this.textContent.trim().toLowerCase());
        });
      });

      // Filtro pelos botões Novidades, Descontos e Populares
      document.querySelectorAll('.main-nav a').forEach(btn => {
        const btnText = btn.textContent.trim().toLowerCase();
        if (["novidades","descontos","populares"].includes(btnText)) {
          btn.addEventListener("click", function(e){
            e.preventDefault();
            filtrarProdutos(btnText, null);
          });
        }
      });
